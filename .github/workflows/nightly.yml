name: Nightly Tests

on:
    schedule:
        # Run at 2 AM UTC every day
        - cron: "0 2 * * *"
    workflow_dispatch:
        inputs:
            simulation:
                description: "Run full 1000-user simulation"
                required: false
                default: false
                type: boolean

jobs:
    # ===========================================
    # Full Nightly Test Suite
    # ===========================================
    nightly-full:
        name: Nightly - Full Test Suite
        runs-on: ubuntu-latest
        timeout-minutes: 120

        defaults:
            run:
                working-directory: golf-ryder-cup-web

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"
                  cache-dependency-path: golf-ryder-cup-web/package-lock.json

            - name: Install dependencies
              run: npm ci

            - name: Install Playwright browsers
              run: npx playwright install --with-deps

            - name: Build application
              run: npm run build

            - name: Run nightly tests
              run: npm run test:nightly
              env:
                  CI: true

            - name: Run chaos tests
              run: npm run test:chaos
              env:
                  CI: true
                  CHAOS_ENABLED: true

            - name: Run fuzz tests (CI mode)
              run: npm run test:fuzz:ci
              env:
                  CI: true

            - name: Upload test artifacts
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: nightly-test-artifacts
                  path: |
                      golf-ryder-cup-web/tests/e2e/artifacts/
                      golf-ryder-cup-web/playwright-report/
                  retention-days: 14

    # ===========================================
    # 1000-User Simulation (Optional)
    # ===========================================
    simulation:
        name: Simulation - 1000 Users
        runs-on: ubuntu-latest
        timeout-minutes: 240
        if: ${{ github.event.inputs.simulation == 'true' || github.event_name == 'schedule' }}
        needs: nightly-full

        defaults:
            run:
                working-directory: golf-ryder-cup-web

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"
                  cache-dependency-path: golf-ryder-cup-web/package-lock.json

            - name: Install dependencies
              run: npm ci

            - name: Install Playwright browsers
              run: npx playwright install --with-deps chromium

            - name: Build application
              run: npm run build

            - name: Run 1000-user simulation
              run: npm run test:simulate:1000
              env:
                  CI: true
                  WORKERS: 4
                  JOURNEY_ITERATIONS: 25
                  CHAOS_ITERATIONS: 10
                  FUZZ_ROUNDS: 5
                  FUZZ_ACTIONS: 50

            - name: Upload simulation report
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: simulation-report
                  path: golf-ryder-cup-web/tests/e2e/artifacts/simulate-1000/
                  retention-days: 30

    # ===========================================
    # Notify on Failure
    # ===========================================
    notify-failure:
        name: Notify - Failure Alert
        runs-on: ubuntu-latest
        needs: [nightly-full]
        if: failure()

        steps:
            - name: Create issue on failure
              uses: actions/github-script@v7
              with:
                  script: |
                      const today = new Date().toISOString().split('T')[0];
                      await github.rest.issues.create({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        title: `Nightly Test Failure - ${today}`,
                        body: `## Nightly Test Failure

                        The nightly test suite failed on ${today}.

                        **Workflow Run:** [View Details](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})

                        Please investigate and fix the failing tests.

                        /cc @${context.actor}`,
                        labels: ['bug', 'tests', 'nightly']
                      });
